# 命令指引

有时候，在接入 ChatGPT 等大语言模型时，一些业务场景只能通过本地进行扩展，而为了最大程度节约 Prompt 文本长度消耗，建立高效上下文填充，是一件颇为挑战的事情。

命令指引，便是为了这个场景而生的。它完全基于 ChatGPT 已有的对话能力和理解能力，通过对对话内容的预测来准备上下文信息，从而实现将业务能力仅通过有限 Prompt 来贯穿整个对话。

## 角色

整个机制的运作，是建立在多个不同角色的基础上的。

- ChatGPT - 提供大语言模型的平台服务。
- 应用服务 - 提供业务支撑的应用程序，或该应用对应的后端服务。
- 用户 - 即进行对话的最终用户。

ChatGPT 除了提供了自然语言对话响应能力以外，还将为应用服务提供用户意图的理解。应用服务根据回传的理解，来确定当前聊天的实时内容，并据此立即准备相关素材，并填入下一轮对话的 Prompt 中，这样 ChatGPT 便能从容应对用户的内容。

因此，ChatGPT 是提供对话内容的核心，而应用服务则利用了 ChatGPT 已有的能力，并对其信息进行及时补充，以确保下一轮对话中 ChatGPT 除了可应用自身知识外，还拥有足够的相关业务信息，最终用人类友好的语言进行应答。因此，用户自始至终都是在和 ChatGPT 对话，而不是应用服务本身，只不过对话内容具备了应用服务所提供的业务特征，以及可能通过富交互的形态获取相关信息。

## 理解和预测

如果需要理解用户当前对话的内容，那么最好的方式便是让 ChatGPT 在应答时直接告诉应用服务。

通过在 Prompt 中约定一套暗号，便能达成这个目的。

这套暗号其实就是一组命令指引。它包括指令代号，以及对应的参数。事先将这组命令指引的所有信息通过 Prompt 进行传递，可以确保 ChatGPT 能在符合其中一项时，按照指定格式进行返回。需要传递的每条命令指引的信息如下。

- 代号，用于匹配具体语义功能，例如“search”。
- 含义，即这个命令指引所描述的是一件什么事情，例如“进行文件搜索”。
- 参数，用于描述为了支撑这条命令所需的必要参数列表，例如“一个参数，搜索关键词”。

由此，ChatGPT 在响应用户对话时，除了生成对应的回答内容时，还能一并生成对应的命令指引信息。应用服务获取到该信息后，便能触发命令功能，例如执行搜索，并呈现给最终用户，同时也将结果进行格式化后，填入下一轮对话的 Prompt 中，以便让 ChatGPT 也具备当前用户已有的上下文。

## 设计指令

命令指引的设计应当具有预见性，而不仅仅是用户当下的指令。因为用户发出这句话时，ChatGPT 已经作答。因此，所需支持的命令指引应当是侧重在当下用户在聊什么内容。

例如，当用户在询问关于什么类型的书籍时，会触发搜索相关指令，此时由于 ChatGPT 已知晓有搜索功能，便会返回类似“好的”的肯定大幅，并通过命令告知应用服务当前用户正在搜索某特定类型的书籍。应用服务此时应当将搜索结果随附在 ChatGPT 的答复下方，并将此列表及其各项的详细信息附在下一轮 Prompt 上，因为此时用户很可能会询问其中一本书的一些信息。当用户真的询问了某书细节时，此时应该将该书更多详细内容附在下一轮 Prompt 上，甚至相关书籍或其它资料的相关信息也带上，以备进一步咨询。以此反复，顺着用户对某一事物的了解深入，将更细致以及周边信息代入，辅助 ChatGPT 提高返回内容质量。

由次可以看出，这些指令都是起到后续指引性质的，因此这种机制称为命令指引。“命令”是对中心词“指引”的修饰，意味着我们基于命令这种形态，来提供指引 ChatGPT 从业务上更专业的角度，来对用户进行应答。

## 刷新内容

有时，ChatGPT 在当前一轮响应时，以显得力不从心，或者用户改变了话题。因此，有一些命令还需要触发对当前对话内容的即时刷新。也就是说，需要发送相同的内容给 ChatGPT，只是 Prompt 代入了更新的信息，待回复收到后，将上一轮的描述进行刷新。

此时，用户可能会先看到一个模糊的回答，或者是可以思考或搜索一下再答复的过渡文案，稍后内容即发生了变化，并给出更合适的答案，因为此时应用服务重新将用户的问题发送出去，并在 Prompt 中代入了对应的完整信息。

大多数时候不会出现这种场景，但刷新内容作为兜底方案，可以避免现有预测能力的遗漏。

## Prompt 模板

Prompt 内容将按照固定模板内容进行填写。

- 业务简介
- 用户基础信息
- 格式描述
- 命令列表
- 指引内容

其中，业务简介指的是，用简短的语言来描述当前是一个什么样的服务，用于覆盖 ChatGPT 本身的角色定义；而用户基础信息则是当前对话者的基本描述，用于让 ChatGPT 知道如何称呼当前用户，以及其它一些必须属性；格式描述则是用于约束 ChatGPT 如何与应用程序进行交互。如下示例。

> You are a helpful assistant. User's name is Kingcean. The user is using a file browser app Trivial Files which also supports following commands if user asks. The commands are only available for you by adding a new line at the end with character prefix in ⨍, command key, a white space and additional parameter. Don't let user send command directly.

随后附上对应的命令清单列表。而在 Prompt 的尾部，则是以此前的命令指引，所获取的信息。

首轮对话时，一般需要根据业务的设计和需要，提供一个初始的指引。例如，文件浏览器可以把用户的近期文件先行罗列，新闻或视频流媒体服务则可列出新热内容。

## 构建

`Trivial.Messages.dll` 库中的 `Trivial.Tasks` 命名空间，提供了先进的复合型支持服务，用于构建适用于服务端和客户端的命令指引库，并于聊天程序相结合。

- `BaseChatCommandGuidanceClient` 提供基于客户端的命令指引支持。
- `BaseChatCommandGuidanceEngine` 提供基于服务端的命令指引支持。

继承并实现上述基类，并加入以下命令指引的继承实现，便可以非常轻松的完成这项完整能力。

- `BaseChatCommandGuidanceProvider` 命令指引能力。
